import fs from "fs";
import glob from "glob";
import path from "path";

const componentExampleEntryPoints = glob.sync("./src/components/*/examples/*.tsx");
const componentExampleEntries = componentExampleEntryPoints.map(entryPoint => {
  const details = entryPoint.match(/components\/(?<component>[^\/]+)\/examples\/(?<example>[^\/]+)\.tsx/).groups;
  return {
    path: path.relative(path.resolve("./src"), entryPoint.replace(".tsx", "")),
    constructorName: `${details.component}__${details.example.replace(/\-/g, "_")}`,
  };
});

const generalExampleEntryPoints = glob.sync("./src/examples/*.tsx");
const generalExampleEntries = generalExampleEntryPoints.map(entryPoint => {
  const details = entryPoint.match(/examples\/(?<example>[^\/]+)\.tsx/).groups;
  return {
    path: path.relative(path.resolve("./src"), entryPoint.replace(".tsx", "")),
    constructorName: `GeneralExample__${details.example.replace(/\-/g, "_")}`,
  };
});

const src = `
// This file is automatically generated by 'yarn build:examples:refresh'.
// Warning: Any manual changes will be lost.

${
  [...componentExampleEntries, ...generalExampleEntries]
  .map(entry => `export { default as ${entry.constructorName} } from "./${entry.path}"`)
  .join("\n")
}
`;

fs.writeFileSync("./src/example-components.ts", src, { encoding: "utf8" });
